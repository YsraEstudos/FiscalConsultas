============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\israe\OneDrive\Documentos\faz tudo\Fiscal\.venv\Scripts\python.exe
cachedir: .pytest_cache
benchmark: 5.2.3 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: C:\Users\israe\OneDrive\Documentos\faz tudo\Fiscal
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0, benchmark-5.2.3, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 383 items

tests/unit/test_ai_service.py::test_init_without_api_key_disables_model PASSED [  0%]
tests/unit/test_ai_service.py::test_init_with_api_key_sets_model PASSED  [  0%]
tests/unit/test_ai_service.py::test_init_with_api_key_handles_provider_error PASSED [  0%]
tests/unit/test_ai_service.py::test_get_chat_response_requires_configured_model PASSED [  1%]
tests/unit/test_ai_service.py::test_get_chat_response_success PASSED     [  1%]
tests/unit/test_ai_service.py::test_get_chat_response_wraps_provider_exception PASSED [  1%]
tests/unit/test_app_lifespan_additional.py::test_no_cache_html_sets_headers_for_html_paths_only PASSED [  1%]
tests/unit/test_app_lifespan_additional.py::test_lifespan_sqlite_init_db_failure_keeps_startup_and_shutdown FAILED [  2%]
tests/unit/test_app_lifespan_additional.py::test_lifespan_sqlite_handles_import_error_for_db_engine PASSED [  2%]
tests/unit/test_app_lifespan_additional.py::test_lifespan_sqlite_init_db_success_closes_sqlmodel_engine PASSED [  2%]
tests/unit/test_app_lifespan_additional.py::test_lifespan_postgres_redis_prewarm_failure_and_tipi_repository FAILED [  2%]
tests/unit/test_app_lifespan_additional.py::test_lifespan_postgres_tipi_count_failure_falls_back_to_sqlite_mode FAILED [  3%]
tests/unit/test_auth_route_helpers.py::test_extract_client_ip_prefers_forwarded_for_header PASSED [  3%]
tests/unit/test_auth_route_helpers.py::test_extract_client_ip_ignores_forwarded_for_when_proxy_not_trusted PASSED [  3%]
tests/unit/test_auth_route_helpers.py::test_extract_client_ip_falls_back_to_request_client PASSED [  3%]
tests/unit/test_auth_route_helpers.py::test_extract_client_ip_returns_unknown_when_not_available PASSED [  4%]
tests/unit/test_auth_route_helpers.py::test_build_limiter_key_uses_user_id_when_token_has_sub PASSED [  4%]
tests/unit/test_auth_route_helpers.py::test_build_limiter_key_falls_back_to_ip_when_sub_missing PASSED [  4%]
tests/unit/test_cache_key_normalization.py::TestCodeQueryNormalization::test_dotted_and_plain_same_key PASSED [  4%]
tests/unit/test_cache_key_normalization.py::TestCodeQueryNormalization::test_whitespace_around_single_code_is_ignored PASSED [  5%]
tests/unit/test_cache_key_normalization.py::TestCodeQueryNormalization::test_dashes_removed_inside_single_code PASSED [  5%]
tests/unit/test_cache_key_normalization.py::TestCodeQueryNormalization::test_equivalent_multi_code_separators_share_same_key PASSED [  5%]
tests/unit/test_cache_key_normalization.py::TestCodeQueryNormalization::test_multi_code_query_does_not_alias_single_code PASSED [  6%]
tests/unit/test_cache_key_normalization.py::TestCodeQueryNormalization::test_etag_differs_for_multi_code_and_single_code PASSED [  6%]
tests/unit/test_cache_key_normalization.py::TestTextQueryNormalization::test_case_insensitive PASSED [  6%]
tests/unit/test_cache_key_normalization.py::TestTextQueryNormalization::test_whitespace_stripped PASSED [  6%]
tests/unit/test_cache_key_normalization.py::TestTextQueryNormalization::test_mixed_case_and_spaces PASSED [  7%]
tests/unit/test_cache_key_normalization.py::TestTextQueryNormalization::test_different_terms_different_key PASSED [  7%]
tests/unit/test_cache_utils.py::test_cache_scope_key_uses_current_tenant PASSED [  7%]
tests/unit/test_cache_utils.py::test_cache_scope_key_fallbacks_without_middleware_import PASSED [  7%]
tests/unit/test_cache_utils.py::test_weak_etag_is_stable_and_namespaced PASSED [  8%]
tests/unit/test_chapter_repository.py::test_get_by_num_returns_loaded_chapter_and_applies_tenant_filter PASSED [  8%]
tests/unit/test_chapter_repository.py::test_get_by_num_as_read_returns_none_when_missing PASSED [  8%]
tests/unit/test_chapter_repository.py::test_to_read_model_maps_positions_and_notes_with_anchor_fallback PASSED [  8%]
tests/unit/test_chapter_repository.py::test_get_all_nums_returns_scalar_list PASSED [  9%]
tests/unit/test_chapter_repository.py::test_search_fulltext_dispatches_by_engine PASSED [  9%]
tests/unit/test_chapter_repository.py::test_fts_postgres_maps_rows_and_tenant_params PASSED [  9%]
tests/unit/test_chapter_repository.py::test_fts_sqlite_maps_rank PASSED  [  9%]
tests/unit/test_chapter_repository.py::test_search_scored_applies_tier_base_and_coverage_bonus PASSED [ 10%]
tests/unit/test_chapter_sections.py::test_extract_chapter_sections_separates_blocks[extract_chapter_sections0] PASSED [ 10%]
tests/unit/test_chapter_sections.py::test_extract_chapter_sections_separates_blocks[extract_chapter_sections1] PASSED [ 10%]
tests/unit/test_db_schema.py::test_chapter_notes_columns_include_sections PASSED [ 10%]
tests/unit/test_db_schema.py::test_chapter_notes_columns_unique PASSED   [ 11%]
tests/unit/test_error_handlers.py::test_nesh_exception_handler_uses_warning_for_4xx PASSED [ 11%]
tests/unit/test_error_handlers.py::test_nesh_exception_handler_uses_error_for_5xx PASSED [ 11%]
tests/unit/test_error_handlers.py::test_generic_exception_handler_returns_sanitized_payload PASSED [ 12%]
tests/unit/test_exceptions_contract.py::test_nesh_error_defaults PASSED  [ 12%]
tests/unit/test_exceptions_contract.py::test_configuration_error_contract PASSED [ 12%]
tests/unit/test_exceptions_contract.py::test_database_error_contract PASSED [ 12%]
tests/unit/test_exceptions_contract.py::test_database_not_found_error_contract PASSED [ 13%]
tests/unit/test_exceptions_contract.py::test_chapter_not_found_error_contract PASSED [ 13%]
tests/unit/test_exceptions_contract.py::test_invalid_query_error_contract PASSED [ 13%]
tests/unit/test_exceptions_contract.py::test_validation_error_contract PASSED [ 13%]
tests/unit/test_exceptions_contract.py::test_service_error_contract PASSED [ 14%]
tests/unit/test_exceptions_contract.py::test_not_found_error_with_identifier PASSED [ 14%]
tests/unit/test_exceptions_contract.py::test_not_found_error_without_identifier PASSED [ 14%]
tests/unit/test_frontend_check.py::test_verify_frontend_build_logs_error_when_build_missing PASSED [ 14%]
tests/unit/test_frontend_check.py::test_verify_frontend_build_warns_when_package_is_newer PASSED [ 15%]
tests/unit/test_frontend_check.py::test_verify_frontend_build_info_when_fresh PASSED [ 15%]
tests/unit/test_frontend_check.py::test_verify_frontend_build_handles_exceptions PASSED [ 15%]
tests/unit/test_logging_config.py::test_setup_logging_handles_windows_stdout_reconfigure_failure PASSED [ 15%]
tests/unit/test_logging_config.py::test_setup_logging_adds_file_handler_when_log_file_provided PASSED [ 16%]
tests/unit/test_logging_config.py::test_get_logger_uses_nesh_prefix PASSED [ 16%]
tests/unit/test_middleware_additional.py::test_get_payload_exp_variants PASSED [ 16%]
tests/unit/test_middleware_additional.py::test_is_payload_expired_variants PASSED [ 16%]
tests/unit/test_middleware_additional.py::test_token_cache_key_is_stable PASSED [ 17%]
tests/unit/test_middleware_additional.py::test_get_jwks_client_caches_instance PASSED [ 17%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_jwks_path_and_cache PASSED [ 17%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_validates_issuer_audience_and_azp PASSED [ 18%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_rejects_audience_mismatch PASSED [ 18%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_rejects_issuer_and_azp_mismatch PASSED [ 18%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_applies_min_clock_skew_in_development PASSED [ 18%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_drops_stale_cache_entry PASSED [ 19%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_evicts_old_entries_when_cache_is_full PASSED [ 19%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_rejects_when_not_development_and_no_jwks PASSED [ 19%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_rejects_dev_without_debug PASSED [ 19%]
tests/unit/test_middleware_additional.py::test_decode_clerk_jwt_handles_invalid_and_expired_exceptions PASSED [ 20%]
tests/unit/test_middleware_additional.py::test_extract_org_from_jwt_and_get_current_tenant PASSED [ 20%]
tests/unit/test_middleware_additional.py::test_is_clerk_token_valid_delegates_to_decode PASSED [ 20%]
tests/unit/test_middleware_additional.py::test_dispatch_skips_non_api_and_public_paths PASSED [ 20%]
tests/unit/test_middleware_additional.py::test_dispatch_returns_401_in_prod_postgres_without_tenant PASSED [ 21%]
tests/unit/test_middleware_additional.py::test_dispatch_sets_tenant_from_debug_fallback_and_resets PASSED [ 21%]
tests/unit/test_middleware_additional.py::test_dispatch_sets_tenant_from_bearer_and_schedules_provision PASSED [ 21%]
tests/unit/test_middleware_additional.py::test_ensure_clerk_entities_returns_early_for_non_postgres PASSED [ 21%]
tests/unit/test_middleware_additional.py::test_ensure_clerk_entities_returns_early_without_user PASSED [ 22%]
tests/unit/test_middleware_additional.py::test_ensure_clerk_entities_skips_when_recently_cached PASSED [ 22%]
tests/unit/test_middleware_additional.py::test_ensure_clerk_entities_creates_tenant_and_user PASSED [ 22%]
tests/unit/test_middleware_additional.py::test_ensure_clerk_entities_updates_existing_records PASSED [ 22%]
tests/unit/test_middleware_additional.py::test_ensure_clerk_entities_eviction_and_exception_path PASSED [ 23%]
tests/unit/test_middleware_jwt_cache.py::test_cached_token_is_rejected_when_expired PASSED [ 23%]
tests/unit/test_middleware_jwt_cache.py::test_expired_payload_is_not_cached_in_development PASSED [ 23%]
tests/unit/test_middleware_jwt_cache.py::test_public_path_matching_does_not_allow_similar_prefixes PASSED [ 24%]
tests/unit/test_ncm_utils.py::test_split_ncm_query_accepts_spaces_as_separator PASSED [ 24%]
tests/unit/test_ncm_utils.py::test_split_ncm_query_accepts_mixed_separators PASSED [ 24%]
tests/unit/test_nesh_service_additional.py::test_create_with_repository_raises_when_repo_is_unavailable PASSED [ 24%]
tests/unit/test_nesh_service_additional.py::test_fts_cache_key_is_deterministic PASSED [ 25%]
tests/unit/test_nesh_service_additional.py::test_get_repo_supports_repository_factory_and_none PASSED [ 25%]
tests/unit/test_nesh_service_additional.py::test_strip_chapter_preamble_and_parse_notes PASSED [ 25%]
tests/unit/test_nesh_service_additional.py::test_fetch_chapter_data_populates_cache_and_reuses_cached_value PASSED [ 25%]
tests/unit/test_nesh_service_additional.py::test_fetch_chapter_data_uses_precomputed_json_and_fallback_parse PASSED [ 26%]
tests/unit/test_nesh_service_additional.py::test_fetch_chapter_data_raises_when_db_adapter_is_missing PASSED [ 26%]
tests/unit/test_nesh_service_additional.py::test_normalize_query_and_normalize_query_raw_apply_filters PASSED [ 26%]
tests/unit/test_nesh_service_additional.py::test_fts_scored_cached_uses_db_once_and_then_hits_memory_cache PASSED [ 26%]
tests/unit/test_nesh_service_additional.py::test_search_full_text_returns_none_match_when_query_becomes_empty PASSED [ 27%]
tests/unit/test_nesh_service_additional.py::test_search_full_text_combines_tiers_and_applies_near_bonus PASSED [ 27%]
tests/unit/test_nesh_service_additional.py::test_search_full_text_returns_warning_when_no_results PASSED [ 27%]
tests/unit/test_nesh_service_additional.py::test_search_by_code_builds_found_and_not_found_chapters PASSED [ 27%]
tests/unit/test_nesh_service_additional.py::test_process_request_dispatches_between_code_and_text PASSED [ 28%]
tests/unit/test_nesh_service_additional.py::test_prewarm_cache_covers_empty_sources_and_exception_path PASSED [ 28%]
tests/unit/test_nesh_service_additional.py::test_get_internal_cache_metrics_returns_current_snapshots PASSED [ 28%]
tests/unit/test_position_repository.py::test_init_uses_tenant_context_when_tenant_not_passed PASSED [ 28%]
tests/unit/test_position_repository.py::test_get_by_codigo_returns_scalar_and_applies_tenant_filter PASSED [ 29%]
tests/unit/test_position_repository.py::test_get_by_chapter_maps_to_position_read PASSED [ 29%]
tests/unit/test_position_repository.py::test_search_by_prefix_normalizes_prefix_and_respects_limit PASSED [ 29%]
tests/unit/test_position_repository.py::test_search_fulltext_dispatches_by_engine PASSED [ 30%]
tests/unit/test_position_repository.py::test_fts_postgres_maps_score_and_sends_tenant_param PASSED [ 30%]
tests/unit/test_position_repository.py::test_fts_sqlite_maps_rank_to_positive_score PASSED [ 30%]
tests/unit/test_rate_limit.py::test_rate_limiter_blocks_after_limit_and_reports_retry PASSED [ 30%]
tests/unit/test_rate_limit.py::test_rate_limiter_window_expires_requests PASSED [ 31%]
tests/unit/test_rate_limit.py::test_rate_limiter_uses_isolated_buckets_per_key PASSED [ 31%]
tests/unit/test_rate_limit.py::test_rate_limiter_reset_clears_state PASSED [ 31%]
tests/unit/test_rate_limit.py::test_rate_limiter_drops_stale_empty_buckets PASSED [ 31%]
tests/unit/test_redis_client.py::test_connect_skips_when_disabled PASSED [ 32%]
tests/unit/test_redis_client.py::test_connect_skips_when_dependency_unavailable PASSED [ 32%]
tests/unit/test_redis_client.py::test_connect_success_and_idempotent PASSED [ 32%]
tests/unit/test_redis_client.py::test_connect_resets_client_on_ping_failure PASSED [ 32%]
tests/unit/test_redis_client.py::test_close_handles_success_and_failure PASSED [ 33%]
tests/unit/test_redis_client.py::test_get_json_and_set_json_happy_path PASSED [ 33%]
tests/unit/test_redis_client.py::test_get_json_returns_none_on_absent_or_error PASSED [ 33%]
tests/unit/test_redis_client.py::test_set_json_handles_serialize_or_write_errors PASSED [ 33%]
tests/unit/test_redis_client.py::test_chapter_and_fts_helpers_use_expected_keys PASSED [ 34%]
tests/unit/test_renderer_additional.py::test_multi_transform_parser_applies_transforms_and_skips_marked_regions PASSED [ 34%]
tests/unit/test_renderer_additional.py::test_convert_text_to_html_returns_empty_for_empty_input PASSED [ 34%]
tests/unit/test_renderer_additional.py::test_convert_text_to_html_builds_heading_lists_and_paragraph_blocks PASSED [ 34%]
tests/unit/test_renderer_additional.py::test_inject_smart_links_handles_plain_text_and_html_skip_zones PASSED [ 35%]
tests/unit/test_renderer_additional.py::test_inject_smart_links_falls_back_when_parser_raises PASSED [ 35%]
tests/unit/test_renderer_additional.py::test_inject_unit_highlights_handles_leading_whitespace_in_match PASSED [ 35%]
tests/unit/test_renderer_additional.py::test_inject_unit_highlights_falls_back_when_parser_raises PASSED [ 36%]
tests/unit/test_renderer_additional.py::test_inject_glossary_highlights_returns_original_when_regex_unavailable PASSED [ 36%]
tests/unit/test_renderer_additional.py::test_inject_glossary_highlights_wraps_terms_when_regex_exists PASSED [ 36%]
tests/unit/test_renderer_additional.py::test_convert_bold_markdown_supports_plain_and_html_text PASSED [ 36%]
tests/unit/test_renderer_additional.py::test_convert_bold_markdown_falls_back_when_parser_raises PASSED [ 37%]
tests/unit/test_renderer_additional.py::test_apply_post_transforms_plain_text_applies_all_layers PASSED [ 37%]
tests/unit/test_renderer_additional.py::test_apply_post_transforms_html_skips_existing_links PASSED [ 37%]
tests/unit/test_renderer_additional.py::test_apply_post_transforms_falls_back_when_parser_raises PASSED [ 37%]
tests/unit/test_renderer_additional.py::test_render_chapter_returns_error_block_when_content_missing PASSED [ 38%]
tests/unit/test_renderer_additional.py::test_render_chapter_structures_sections_normalizes_lines_and_trims_other_chapter PASSED [ 38%]
tests/unit/test_renderer_additional.py::test_render_chapter_trims_at_section_header PASSED [ 38%]
tests/unit/test_renderer_additional.py::test_render_chapter_renders_structured_sections_with_navigation_ids PASSED [ 38%]
tests/unit/test_renderer_additional.py::test_render_full_response_continues_when_one_chapter_raises PASSED [ 39%]
tests/unit/test_renderer_regex.py::TestRendererRegex::test_regex_standard_ncm PASSED [ 39%]
tests/unit/test_renderer_regex.py::TestRendererRegex::test_regex_indented_ncm PASSED [ 39%]
tests/unit/test_renderer_regex.py::TestRendererRegex::test_regex_fallback_logic PASSED [ 39%]
tests/unit/test_renderer_regex.py::TestRendererRegex::test_regex_false_positives PASSED [ 40%]
tests/unit/test_renderer_regex.py::TestRendererRegex::test_regex_with_dots PASSED [ 40%]
tests/unit/test_system_route_helpers.py::test_normalize_db_status_with_missing_payload_returns_error_contract PASSED [ 40%]
tests/unit/test_system_route_helpers.py::test_normalize_db_status_with_valid_stats_coerces_values PASSED [ 40%]
tests/unit/test_system_route_helpers.py::test_normalize_tipi_status_handles_online_and_error_states PASSED [ 41%]
tests/unit/test_system_route_helpers.py::test_is_admin_request_accepts_valid_admin_token PASSED [ 41%]
tests/unit/test_system_route_helpers.py::test_is_admin_request_accepts_admin_role_in_jwt PASSED [ 41%]
tests/unit/test_system_route_helpers.py::test_is_admin_request_rejects_non_admin_user PASSED [ 42%]
tests/unit/test_system_routes_endpoints.py::test_to_int_returns_default_on_invalid_values PASSED [ 42%]
tests/unit/test_system_routes_endpoints.py::test_get_status_uses_app_state_services_when_available PASSED [ 42%]
tests/unit/test_system_routes_endpoints.py::test_get_status_uses_db_engine_fallback_when_db_not_in_state PASSED [ 42%]
tests/unit/test_system_routes_endpoints.py::test_get_status_handles_db_and_tipi_exceptions PASSED [ 43%]
tests/unit/test_system_routes_endpoints.py::test_get_cache_metrics_rejects_non_admin PASSED [ 43%]
tests/unit/test_system_routes_endpoints.py::test_get_cache_metrics_returns_payload_for_admin PASSED [ 43%]
tests/unit/test_system_routes_endpoints.py::test_debug_anchors_returns_404_when_debug_mode_is_disabled PASSED [ 43%]
tests/unit/test_system_routes_endpoints.py::test_debug_anchors_returns_403_for_non_admin PASSED [ 44%]
tests/unit/test_system_routes_endpoints.py::test_debug_anchors_filters_position_related_ids PASSED [ 44%]
tests/unit/test_system_routes_endpoints.py::test_reload_secrets_rejects_non_admin PASSED [ 44%]
tests/unit/test_system_routes_endpoints.py::test_reload_secrets_calls_reload_for_admin PASSED [ 44%]
tests/unit/test_text_processor.py::test_stemmer_plural_rules_cover_specific_suffixes PASSED [ 45%]
tests/unit/test_text_processor.py::test_stemmer_feminine_rules PASSED    [ 45%]
tests/unit/test_text_processor.py::test_stem_normalizes_case_and_accent PASSED [ 45%]
tests/unit/test_text_processor.py::test_processor_normalize_and_process_with_stopwords PASSED [ 45%]
tests/unit/test_text_processor.py::test_process_ignores_single_letters_and_stopwords PASSED [ 46%]
tests/unit/test_text_processor.py::test_process_query_for_fts_appends_wildcards PASSED [ 46%]
tests/unit/test_text_processor.py::test_process_query_exact_without_wildcards PASSED [ 46%]
tests/unit/test_text_processor.py::test_step_augmentative_is_noop PASSED [ 46%]
tests/unit/test_text_processor.py::test_replace_suffix_returns_original_when_suffix_not_present PASSED [ 47%]
tests/unit/test_tipi_renderer_ids.py::test_renderer_outputs_compatible_ids PASSED [ 47%]
tests/unit/test_tipi_repository.py::test_get_by_codigo_returns_scalar PASSED [ 47%]
tests/unit/test_tipi_repository.py::test_get_by_chapter_maps_defaults_and_anchor PASSED [ 48%]
tests/unit/test_tipi_repository.py::test_get_family_positions_postgres_builds_named_params PASSED [ 48%]
tests/unit/test_tipi_repository.py::test_get_family_positions_sqlite_builds_tuple_params PASSED [ 48%]
tests/unit/test_tipi_repository.py::test_search_fulltext_dispatches_by_engine PASSED [ 48%]
tests/unit/test_tipi_repository.py::test_fts_postgres_maps_rows PASSED   [ 49%]
tests/unit/test_tipi_repository.py::test_fts_sqlite_quotes_query PASSED  [ 49%]
tests/unit/test_tipi_repository.py::test_get_all_chapters_supports_postgres_and_sqlite PASSED [ 49%]
tests/unit/test_tipi_route_highlights.py::TestApplyHighlightsToDescriptions::test_code_search_applies_unit_highlights PASSED [ 49%]
tests/unit/test_tipi_route_highlights.py::TestApplyHighlightsToDescriptions::test_text_search_applies_unit_highlights PASSED [ 50%]
tests/unit/test_tipi_route_highlights.py::TestApplyHighlightsToDescriptions::test_applies_exclusion_highlights PASSED [ 50%]
tests/unit/test_tipi_route_highlights.py::TestApplyHighlightsToDescriptions::test_empty_results_no_error PASSED [ 50%]
tests/unit/test_tipi_route_highlights.py::TestApplyHighlightsToDescriptions::test_none_results_no_error PASSED [ 50%]
tests/unit/test_tipi_route_highlights.py::TestApplyHighlightsToDescriptions::test_empty_description_no_error PASSED [ 51%]
tests/unit/test_tipi_route_highlights.py::TestApplyHighlightsToDescriptions::test_no_units_no_highlights PASSED [ 51%]
tests/unit/test_tipi_route_highlights.py::TestApplyHighlightsToDescriptions::test_new_units_applied PASSED [ 51%]
tests/unit/test_tipi_service_additional.py::test_create_with_repository_raises_when_repo_unavailable PASSED [ 51%]
tests/unit/test_tipi_service_additional.py::test_create_with_repository_success_uses_factory PASSED [ 52%]
tests/unit/test_tipi_service_additional.py::test_get_repo_handles_direct_factory_and_none PASSED [ 52%]
tests/unit/test_tipi_service_additional.py::test_get_connection_raises_database_error_when_connect_fails PASSED [ 52%]
tests/unit/test_tipi_service_additional.py::test_release_connection_closes_when_pool_is_full_and_close_fails PASSED [ 53%]
tests/unit/test_tipi_service_additional.py::test_close_handles_pool_connection_close_errors PASSED [ 53%]
tests/unit/test_tipi_service_additional.py::test_check_connection_returns_error_when_db_missing PASSED [ 53%]
tests/unit/test_tipi_service_additional.py::test_check_connection_returns_error_when_query_fails PASSED [ 53%]
tests/unit/test_tipi_service_additional.py::test_get_table_columns_uses_cache PASSED [ 54%]
tests/unit/test_tipi_service_additional.py::test_get_chapter_positions_repository_mode_normalizes_and_evicts PASSED [ 54%]
tests/unit/test_tipi_service_additional.py::test_get_chapter_positions_sqlite_mode_evicts_cache PASSED [ 54%]
tests/unit/test_tipi_service_additional.py::test_get_family_positions_repository_mode PASSED [ 54%]
tests/unit/test_tipi_service_additional.py::test_search_by_code_handles_multi_part_merge_with_same_chapter PASSED [ 55%]
tests/unit/test_tipi_service_additional.py::test_search_by_code_returns_empty_when_query_has_no_digits PASSED [ 55%]
tests/unit/test_tipi_service_additional.py::test_search_by_code_evicts_code_cache_when_limit_is_zero PASSED [ 55%]
tests/unit/test_tipi_service_additional.py::test_search_text_repository_mode_returns_repo_payload PASSED [ 55%]
tests/unit/test_tipi_service_additional.py::test_search_text_sqlite_mode_runs_and_query_fallback PASSED [ 56%]
tests/unit/test_tipi_service_additional.py::test_get_all_chapters_repository_and_sqlite_modes PASSED [ 56%]
tests/unit/test_tipi_service_additional.py::test_get_internal_cache_metrics_reports_snapshots PASSED [ 56%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_highlights_kw_and_litros PASSED [ 56%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_no_units_no_highlight PASSED [ 57%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_empty_description PASSED [ 57%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_multi_letter_units_in_position[kWh] PASSED [ 57%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_multi_letter_units_in_position[kVA] PASSED [ 57%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_multi_letter_units_in_position[Hz] PASSED [ 58%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_multi_letter_units_in_position[rpm] PASSED [ 58%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_multi_letter_units_in_position[MPa] PASSED [ 58%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_multi_letter_units_in_position[kg] PASSED [ 59%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_multi_letter_units_in_position[km] PASSED [ 59%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_multi_letter_units_in_position[ha] PASSED [ 59%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_single_letter_units_in_position[W] PASSED [ 59%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_single_letter_units_in_position[V] PASSED [ 60%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_single_letter_units_in_position[A] PASSED [ 60%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_single_letter_units_in_position[m] PASSED [ 60%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_single_letter_units_in_position[g] PASSED [ 60%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_single_letter_units_in_position[N] PASSED [ 61%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderPositionUnits::test_single_letter_units_in_position[J] PASSED [ 61%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderTextResultsUnits::test_highlights_w_and_litros PASSED [ 61%]
tests/unit/test_tipi_unit_highlights.py::TestTipiRenderTextResultsUnits::test_no_units_no_highlight PASSED [ 61%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[dB] PASSED [ 62%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[\u03a9] PASSED [ 62%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[k\u03a9] PASSED [ 62%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[ohm] PASSED [ 62%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[\xb5F] PASSED [ 63%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[pF] PASSED [ 63%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[kN] PASSED [ 63%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[daN] PASSED [ 63%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[kJ] PASSED [ 64%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[MJ] PASSED [ 64%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[lm] PASSED [ 64%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[lux] PASSED [ 65%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[Btu] PASSED [ 65%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_multi_letter_units_in_position[psi] PASSED [ 65%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_polegadas_in_position PASSED [ 65%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_bar_after_digit_in_position PASSED [ 66%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_bar_without_digit_no_highlight PASSED [ 66%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_units_in_text_results[dB] PASSED [ 66%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_units_in_text_results[psi] PASSED [ 66%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_units_in_text_results[Btu] PASSED [ 67%]
tests/unit/test_tipi_unit_highlights.py::TestTipiNewUnits::test_new_units_in_text_results[lm] PASSED [ 67%]
tests/unit/test_tipi_unit_highlights.py::TestTipiEdgeCases::test_multiple_units_in_one_position PASSED [ 67%]
tests/unit/test_tipi_unit_highlights.py::TestTipiEdgeCases::test_unit_glued_to_number PASSED [ 67%]
tests/unit/test_tipi_unit_highlights.py::TestTipiEdgeCases::test_decimal_with_comma PASSED [ 68%]
tests/unit/test_tipi_unit_highlights.py::TestTipiEdgeCases::test_exclusion_and_unit_highlights_coexist PASSED [ 68%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kWh] PASSED [ 68%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[MWh] PASSED [ 68%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[Wh] PASSED [ 69%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kVA] PASSED [ 69%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[VA] PASSED [ 69%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kW] PASSED [ 69%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[MW] PASSED [ 70%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[mV] PASSED [ 70%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kV] PASSED [ 70%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[mA] PASSED [ 71%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kA] PASSED [ 71%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[Ah] PASSED [ 71%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[mAh] PASSED [ 71%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[Hz] PASSED [ 72%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kHz] PASSED [ 72%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[MHz] PASSED [ 72%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[GHz] PASSED [ 72%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[rpm] PASSED [ 73%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[mbar] PASSED [ 73%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[MPa] PASSED [ 73%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kPa] PASSED [ 73%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[Pa] PASSED [ 74%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[psi] PASSED [ 74%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kg] PASSED [ 74%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[mg] PASSED [ 74%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[km] PASSED [ 75%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[cm] PASSED [ 75%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[mm] PASSED [ 75%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[ml] PASSED [ 75%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[ha] PASSED [ 76%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[dB] PASSED [ 76%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[lux] PASSED [ 76%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[lm] PASSED [ 77%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[Btu] PASSED [ 77%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kN] PASSED [ 77%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[daN] PASSED [ 77%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[MJ] PASSED [ 78%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[kJ] PASSED [ 78%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_multi_letter_unit_highlighted[pol] PASSED [ 78%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_unicode_prefix_units[\xb5m] PASSED [ 78%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_unicode_prefix_units[nm] PASSED [ 79%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_unicode_prefix_units[\xb5F] PASSED [ 79%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_unicode_prefix_units[pF] PASSED [ 79%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_unicode_prefix_units[nF] PASSED [ 79%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_unicode_prefix_units[mF] PASSED [ 80%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_unicode_prefix_units[\xb5H] PASSED [ 80%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_unicode_prefix_units[mH] PASSED [ 80%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_resistance_units[\u03a9] PASSED [ 80%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_resistance_units[k\u03a9] PASSED [ 81%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_resistance_units[M\u03a9] PASSED [ 81%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_resistance_units[ohm] PASSED [ 81%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_temperature_units PASSED [ 81%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_volume_and_area_units PASSED [ 82%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_tonelada_singular_and_plural PASSED [ 82%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_litros_singular_and_plural PASSED [ 82%]
tests/unit/test_unit_highlights.py::TestMultiLetterUnits::test_polegadas_singular_and_plural PASSED [ 83%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[W] PASSED [ 83%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[V] PASSED [ 83%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[A] PASSED [ 83%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[K] PASSED [ 84%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[m] PASSED [ 84%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[l] PASSED [ 84%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[t] PASSED [ 84%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[g] PASSED [ 85%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[N] PASSED [ 85%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_after_digit[J] PASSED [ 85%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[W] PASSED [ 85%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[V] PASSED [ 86%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[A] PASSED [ 86%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[K] PASSED [ 86%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[m] PASSED [ 86%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[l] PASSED [ 87%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[t] PASSED [ 87%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[g] PASSED [ 87%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[N] PASSED [ 87%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_single_letter_without_digit_not_highlighted[J] PASSED [ 88%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_bar_after_digit_highlighted PASSED [ 88%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_bar_without_digit_not_highlighted PASSED [ 88%]
tests/unit/test_unit_highlights.py::TestSingleLetterUnits::test_bar_in_mbar_still_works PASSED [ 89%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_portuguese_article_um_not_highlighted PASSED [ 89%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_preposition_a_not_highlighted PASSED [ 89%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_m_inside_word_not_highlighted PASSED [ 89%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_pa_inside_word_not_highlighted PASSED [ 90%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_kg_inside_word_not_highlighted PASSED [ 90%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_ha_inside_word_not_highlighted PASSED [ 90%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_va_as_verb_not_highlighted PASSED [ 90%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_n_in_word_not_highlighted PASSED [ 91%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_j_in_word_not_highlighted PASSED [ 91%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_text_without_any_units PASSED [ 91%]
tests/unit/test_unit_highlights.py::TestFalsePositives::test_empty_string PASSED [ 91%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_unit_glued_to_number PASSED [ 92%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_unit_after_number_with_space PASSED [ 92%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_unit_followed_by_period PASSED [ 92%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_unit_followed_by_comma PASSED [ 92%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_unit_in_parentheses PASSED [ 93%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_decimal_with_comma PASSED [ 93%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_thousand_separator_with_period PASSED [ 93%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_single_letter_with_multiple_spaces PASSED [ 93%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_single_letter_with_4_spaces_not_matched PASSED [ 94%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_multiple_units_in_one_text PASSED [ 94%]
tests/unit/test_unit_highlights.py::TestEdgeCases::test_case_insensitive_matching PASSED [ 94%]
tests/unit/test_unit_highlights.py::TestHtmlAwareness::test_ignores_units_inside_smart_links PASSED [ 95%]
tests/unit/test_unit_highlights.py::TestHtmlAwareness::test_units_outside_tags_highlighted PASSED [ 95%]
tests/unit/test_unit_highlights.py::TestHtmlAwareness::test_plain_text_fast_path PASSED [ 95%]
tests/unit/test_unit_highlights.py::TestHtmlAwareness::test_malformed_html_fallback PASSED [ 95%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_db_decibel PASSED [ 96%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_ohm_variants PASSED [ 96%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_capacitance_units PASSED [ 96%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_inductance_units PASSED [ 96%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_force_units PASSED [ 97%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_energy_joule PASSED [ 97%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_illumination_units PASSED [ 97%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_btu PASSED        [ 97%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_psi PASSED        [ 98%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_polegadas PASSED  [ 98%]
tests/unit/test_unit_highlights.py::TestNewUnits::test_pol_abbreviation PASSED [ 98%]
tests/unit/test_webhooks_helpers.py::test_parse_date_handles_valid_and_invalid_values PASSED [ 98%]
tests/unit/test_webhooks_helpers.py::test_parse_datetime_normalizes_utc_timezone PASSED [ 99%]
tests/unit/test_webhooks_helpers.py::test_parse_datetime_returns_none_for_invalid_values PASSED [ 99%]
tests/unit/test_webhooks_helpers.py::test_is_valid_webhook_without_configured_token PASSED [ 99%]
tests/unit/test_webhooks_helpers.py::test_is_valid_webhook_with_required_token PASSED [100%]

================================== FAILURES ===================================
_______ test_lifespan_sqlite_init_db_failure_keeps_startup_and_shutdown _______

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001D0FEFE2350>

    @pytest.mark.asyncio
    async def test_lifespan_sqlite_init_db_failure_keeps_startup_and_shutdown(monkeypatch):
        fake_db = _FakeDbAdapter("db.sqlite")
        fake_calls = {"glossary": False, "frontend": False, "redis_closed": False}
    
        class _FakeNeshService:
            def __init__(self, db):
                self.db = db
    
        class _FakeTipiService:
            def __init__(self):
                self.mode = "sqlite"
    
        class _FakeAiService:
            pass
    
        async def _init_db_fail():
            raise RuntimeError("unsupported sqlite extension")
    
        async def _redis_close():
            fake_calls["redis_closed"] = True
            app_module.redis_cache._client = None
    
        monkeypatch.setattr(app_module.settings.database, "engine", "sqlite")
        monkeypatch.setattr(app_module.settings.cache, "enable_redis", False)
        monkeypatch.setattr(app_module, "DatabaseAdapter", lambda _path: fake_db)
        monkeypatch.setattr(db_engine, "init_db", _init_db_fail)
        monkeypatch.setattr(db_engine, "close_db", lambda: None)
        monkeypatch.setattr(nesh_service_module, "NeshService", _FakeNeshService)
        monkeypatch.setattr(tipi_service_module, "TipiService", _FakeTipiService)
        monkeypatch.setattr(ai_service_module, "AiService", _FakeAiService)
        monkeypatch.setattr(
            app_module,
            "init_glossary",
            lambda _root: fake_calls.__setitem__("glossary", True),
        )
        monkeypatch.setattr(
            app_module,
            "verify_frontend_build",
            lambda _root: fake_calls.__setitem__("frontend", True),
        )
        monkeypatch.setattr(app_module.redis_cache, "close", _redis_close)
    
        app = _FakeApp()
        async with app_module.lifespan(app):
            assert app.state.sqlmodel_enabled is False
            assert app.state.service.db is fake_db
>           assert app.state.tipi_service.mode == "sqlite"
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'TipiService' object has no attribute 'mode'

tests\unit\test_app_lifespan_additional.py:109: AttributeError
---------------------------- Captured stdout call -----------------------------
2026-02-20 10:35:26 | INFO     | nesh.service | TipiService inicializado (modo: aiosqlite)
------------------------------ Captured log call ------------------------------
WARNING  server:app.py:76 SQLModel init skipped (SQLite incompatibility): unsupported sqlite extension
INFO     nesh.service:tipi_service.py:91 TipiService inicializado (modo: aiosqlite)
WARNING  ai_service:ai_service.py:22 GOOGLE_API_KEY not found. AI features disabled.
______ test_lifespan_postgres_redis_prewarm_failure_and_tipi_repository _______

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001D0FEF2AF30>

    @pytest.mark.asyncio
    async def test_lifespan_postgres_redis_prewarm_failure_and_tipi_repository(monkeypatch):
        redis_events = {"connected": False, "closed": False}
    
        class _FakeNeshService:
            async def prewarm_cache(self):
                raise RuntimeError("prewarm failed")
    
            @classmethod
            async def create_with_repository(cls):
                return cls()
    
        class _FakeTipiService:
            @classmethod
            async def create_with_repository(cls):
                obj = cls()
                obj.mode = "repo"
                return obj
    
            def __init__(self):
                self.mode = "sqlite"
    
        class _FakeAiService:
            pass
    
        class _ScalarResult:
            def __init__(self, value):
                self._value = value
    
            def scalar(self):
                return self._value
    
        class _Session:
            async def execute(self, _query):
                return _ScalarResult(123)
    
        @asynccontextmanager
        async def _fake_get_session():
            yield _Session()
    
        async def _redis_connect():
            redis_events["connected"] = True
            app_module.redis_cache._client = object()
    
        async def _redis_close():
            redis_events["closed"] = True
            app_module.redis_cache._client = None
    
        async def _close_db_fail():
            raise RuntimeError("close failed")
    
        monkeypatch.setattr(app_module.settings.database, "engine", "postgresql")
        monkeypatch.setattr(app_module.settings.cache, "enable_redis", True)
        monkeypatch.setattr(db_engine, "get_session", _fake_get_session)
        monkeypatch.setattr(db_engine, "close_db", _close_db_fail)
        monkeypatch.setattr(nesh_service_module, "NeshService", _FakeNeshService)
        monkeypatch.setattr(tipi_service_module, "TipiService", _FakeTipiService)
        monkeypatch.setattr(ai_service_module, "AiService", _FakeAiService)
        monkeypatch.setattr(app_module, "init_glossary", lambda _root: None)
        monkeypatch.setattr(app_module, "verify_frontend_build", lambda _root: None)
        monkeypatch.setattr(app_module.redis_cache, "connect", _redis_connect)
        monkeypatch.setattr(app_module.redis_cache, "close", _redis_close)
    
        app = _FakeApp()
        async with app_module.lifespan(app):
            assert app.state.db is None
            assert app.state.sqlmodel_enabled is True
            assert isinstance(app.state.service, _FakeNeshService)
>           assert getattr(app.state.tipi_service, "mode") == "repo"
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'TipiService' object has no attribute 'mode'

tests\unit\test_app_lifespan_additional.py:276: AttributeError
---------------------------- Captured stdout call -----------------------------
2026-02-20 10:35:27 | INFO     | nesh.service | TipiService inicializado (modo: Repository)
------------------------------ Captured log call ------------------------------
WARNING  server:app.py:99 Cache prewarm failed: prewarm failed
INFO     nesh.service:tipi_service.py:91 TipiService inicializado (modo: Repository)
WARNING  ai_service:ai_service.py:22 GOOGLE_API_KEY not found. AI features disabled.
_____ test_lifespan_postgres_tipi_count_failure_falls_back_to_sqlite_mode _____

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001D0FF076D50>

    @pytest.mark.asyncio
    async def test_lifespan_postgres_tipi_count_failure_falls_back_to_sqlite_mode(
        monkeypatch,
    ):
        class _FakeNeshService:
            @classmethod
            async def create_with_repository(cls):
                return cls()
    
        class _FakeTipiService:
            created_repo = False
    
            @classmethod
            async def create_with_repository(cls):
                cls.created_repo = True
                return cls()
    
            def __init__(self):
                self.mode = "sqlite-fallback"
    
        class _FakeAiService:
            pass
    
        @asynccontextmanager
        async def _broken_get_session():
            raise RuntimeError("tipi count failed")
            yield
    
        async def _redis_close():
            app_module.redis_cache._client = None
    
        async def _close_db_ok():
            return None
    
        monkeypatch.setattr(app_module.settings.database, "engine", "postgresql")
        monkeypatch.setattr(app_module.settings.cache, "enable_redis", False)
        monkeypatch.setattr(db_engine, "get_session", _broken_get_session)
        monkeypatch.setattr(db_engine, "close_db", _close_db_ok)
        monkeypatch.setattr(nesh_service_module, "NeshService", _FakeNeshService)
        monkeypatch.setattr(tipi_service_module, "TipiService", _FakeTipiService)
        monkeypatch.setattr(ai_service_module, "AiService", _FakeAiService)
        monkeypatch.setattr(app_module, "init_glossary", lambda _root: None)
        monkeypatch.setattr(app_module, "verify_frontend_build", lambda _root: None)
        monkeypatch.setattr(app_module.redis_cache, "close", _redis_close)
    
        app = _FakeApp()
        async with app_module.lifespan(app):
            assert app.state.sqlmodel_enabled is True
>           assert app.state.tipi_service.mode == "sqlite-fallback"
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'TipiService' object has no attribute 'mode'

tests\unit\test_app_lifespan_additional.py:330: AttributeError
---------------------------- Captured stdout call -----------------------------
2026-02-20 10:35:27 | INFO     | nesh.service | TipiService inicializado (modo: aiosqlite)
------------------------------ Captured log call ------------------------------
WARNING  server:app.py:117 Could not check tipi_positions table: tipi count failed
INFO     nesh.service:tipi_service.py:91 TipiService inicializado (modo: aiosqlite)
WARNING  ai_service:ai_service.py:22 GOOGLE_API_KEY not found. AI features disabled.
============================== warnings summary ===============================
backend\services\ai_service.py:3
  C:\Users\israe\OneDrive\Documentos\faz tudo\Fiscal\tests\..\backend\services\ai_service.py:3: FutureWarning: 
  
  All support for the `google.generativeai` package has ended. It will no longer be receiving 
  updates or bug fixes. Please switch to the `google.genai` package as soon as possible.
  See README for more details:
  
  https://github.com/google-gemini/deprecated-generative-ai-python/blob/main/README.md
  
    import google.generativeai as genai

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/unit/test_app_lifespan_additional.py::test_lifespan_sqlite_init_db_failure_keeps_startup_and_shutdown
FAILED tests/unit/test_app_lifespan_additional.py::test_lifespan_postgres_redis_prewarm_failure_and_tipi_repository
FAILED tests/unit/test_app_lifespan_additional.py::test_lifespan_postgres_tipi_count_failure_falls_back_to_sqlite_mode
================== 3 failed, 380 passed, 1 warning in 1.64s ===================
